<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=9">
<meta name="generator" content="Doxygen 1.8.13">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CMSimple_XH: CSRF Protection</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />


<script type="text/javascript" src="js/syntaxhighlighter/scripts/XRegExp.js"></script>
<script type="text/javascript" src="js/syntaxhighlighter/scripts/shCore.js"></script>
<script type="text/javascript" src="js/syntaxhighlighter/scripts/shAutoloader.js"></script>
<link href="js/syntaxhighlighter/styles/shCoreDefault.css"" type="text/css" rel="stylesheet" />

</head>
<body cz-shortcut-listen="true">
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.jpg"></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CMSimple_XH
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>



<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<div class="header">
  <div class="headertitle">
<div class="title">CSRF Protection </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#usage">Usage </a></li>
<li class="level1"><a href="#stronger-protection">Stronger Protection </a></li>
<li class="level1"><a href="#external-scripts">External Scripts </a></li>
</ul>
</div>
<div class="textblock"><p>According to <a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">Wikipedia</a>: </p><blockquote class="doxtable">
<p>CSRF (Cross-site request forgery) is a type of malicious exploit of a
 website whereby unauthorized commands are transmitted from a user that 
the website trusts. </p>
</blockquote>
<p>Regarding CMSimple_XH this user is typically the administrator, who 
could be tricked to trigger a forged HTML request while being logged in 
to his website. This way an attacker can potentially do anything the 
admin is allowed to do, e.g. changing the configuration settings and 
modifying the template. While the risk of a CSRF attack may be low for a
 CMSimple_XH website, the severity would be very high, so it is 
reasonable to take precautions.</p>
<p>The CSRF protection of CMSimple_XH is based on randomly created 
128bit values (aka. tokens) which are placed on each respective form and
 are stored in the user's session data. On form submission the tokens 
are compared, and if they are not equal, the form submission is 
rejected. The tokens are renewed for each session, so an attacker who 
wants to forge a form has to &lt;emphasis&gt;guess&lt;/emphasis&gt; the 
currently expected token, what makes the success of an attack highly 
unlikely.</p>
<p>For now, the CSRF protection functionality is made available as a global object, <a class="el" href="cms_8php.html#a022468ab9e95e63bbd1570bb56616e8e">$_XH_csrfProtection</a>; this is quite likely to change in a future version.</p>
<h1><a class="anchor" id="usage"></a>
Usage </h1>
<p>Every form which has to be protected against CSRF attacks has to be 
extended by a hidden input element which can be inserted by calling <code><a class="el" href="class_x_h_1_1_c_s_r_f_protection.html#a03cc85dba14fb59b3e816388b871087a">XH::CSRFProtection::tokenInput()</a></code>, e.g.:</p>
<div class="fragment"><div class="line">&lt;form action="..." method="post"&gt;</div><div class="line"></div><div class="line">&lt;?php echo $_XH_csrfProtection-&gt;tokenInput();?&gt;</div><div class="line">&lt;/form&gt;</div></div><!-- fragment --><p>On form submission the tokens have to be checked by calling <code><a class="el" href="class_x_h_1_1_c_s_r_f_protection.html#ace0277a41032653138d9a8a5023a7a5c">XH::CSRFProtection::check()</a></code>.
 If the tokens do not match, script execution will be immediately 
terminated with an appropriate message. Giving a clear indication of the
 error is reasonable in this case, as the message will not be seen by 
the attacker, but by the administrator, who can easily conclude that 
somebody attempted a CSRF attack against his website. An example of the 
check:</p>
<div class="fragment"><div class="line">if (isset($_POST['my_form'])) {</div><div class="line">    $_XH_csrfProtection-&gt;check();</div><div class="line">    // processing form submission</div><div class="line">}</div></div><!-- fragment --><p>Basically
 that's all. The details of creating new CSRF tokens when required and 
storing the latest token in the session are handled by CMSimple_XH. 
Everything is supposed to work fine, even if multiple forms with CSRF 
protection will be emitted for a single document (aka. CMSimple_XH 
page).</p>
<p>The complete CSRF protection is already in place for the core of 
CMSimple_XH and the administration forms of plugins, which are handled 
by <code><a class="el" href="adminfuncs_8php.html#a7532bf327df77f5a630d73d32e851ea4">plugin_admin_common()</a></code>. Other forms require to add CSRF protection in the way described above.</p>
<h1><a class="anchor" id="stronger-protection"></a>
Stronger Protection </h1>
<p>While a common token for each session gives reasonable protection 
againgst CSRF attacks, a new token for each request is even more secure.
 However, the latter has several limitations regarding Ajax, separate 
windows and multiple browser tabs, as these might renew the token 
despite the old token still being present on forms which should be 
submittable. Therefore we have decided to stick with the more foolproof 
and flexible approach to renew the token once per session.</p>
<p>The <code><a class="el" href="class_x_h_1_1_c_s_r_f_protection.html">XH::CSRFProtection</a></code>
 class, however, allows you to handle your own CSRF token and to choose 
whether this is renewed once per session of per request. To do so create
 your own instance of the class and pass it an own key name and whether 
you want a new token for each request. In addition to the handling 
explained above, one has to call <code><a class="el" href="class_x_h_1_1_c_s_r_f_protection.html#a8826337c781700ed44d6a84e1b1cd730">XH::CSRFProtection::store()</a></code> to store the CSRF token in the session variable at the end of the request. An outline:</p>
<div class="fragment"><div class="line">require_once $pth['folder']['classes'] . 'CSRFProtection.php';</div><div class="line">$myCsrfProtection = new XH_CSRFProtection('my_csrf_key', true);</div><div class="line">if (!isset($_POST[...])) {</div><div class="line">    echo '&lt;form ...&gt;';</div><div class="line">    // emit form input elements</div><div class="line">    echo $myCsrfProtection-&gt;tokenInput();</div><div class="line">    echo '&lt;/form&gt;';</div><div class="line">    $myCsrfProtection-&gt;store();</div><div class="line">} else {</div><div class="line">    $myCsrfProtection-&gt;check();</div><div class="line">    // processing of form submission</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="external-scripts"></a>
External Scripts </h1>
<p>Sometimes a plugin requests an "external" script, i.e. does not 
request an index.php of the CMSimple_XH installation. In this case you 
can't use the <code><a class="el" href="class_x_h_1_1_c_s_r_f_protection.html">XH::CSRFProtection</a></code>
 class at all, because this class depends on variables, constants etc. 
which will be set up by CMSimple_XH. You might get the class to work 
properly, but the definition of the class might change in the next 
version. So you're better off to implement your own CSRF protection in 
this case. </p>
</div></div><!-- contents -->
<!-- start footer part -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">構築:
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>





<script>
SyntaxHighlighter.autoloader
(
"applescript            js/syntaxhighlighter/scripts/shBrushAppleScript.js",
"actionscript3 as3      js/syntaxhighlighter/scripts/shBrushAS3.js",
"bash shell             js/syntaxhighlighter/scripts/shBrushBash.js",
"coldfusion cf          js/syntaxhighlighter/scripts/shBrushColdFusion.js",
"cpp c                  js/syntaxhighlighter/scripts/shBrushCpp.js",
"c# c-sharp csharp      js/syntaxhighlighter/scripts/shBrushCSharp.js",
"css                    js/syntaxhighlighter/scripts/shBrushCss.js",
"delphi pascal          js/syntaxhighlighter/scripts/shBrushDelphi.js",
"diff patch pas         js/syntaxhighlighter/scripts/shBrushDiff.js",
"erl erlang             js/syntaxhighlighter/scripts/shBrushErlang.js",
"groovy                 js/syntaxhighlighter/scripts/shBrushGroovy.js",
"java                   js/syntaxhighlighter/scripts/shBrushJava.js",
"jfx javafx             js/syntaxhighlighter/scripts/shBrushJavaFX.js",
"js jscript javascript  js/syntaxhighlighter/scripts/shBrushJScript.js",
"perl pl                js/syntaxhighlighter/scripts/shBrushPerl.js",
"php                    js/syntaxhighlighter/scripts/shBrushPhp.js",
"text plain             js/syntaxhighlighter/scripts/shBrushPlain.js",
"py python              js/syntaxhighlighter/scripts/shBrushPython.js",
"ruby rails ror rb      js/syntaxhighlighter/scripts/shBrushRuby.js",
"sass scss              js/syntaxhighlighter/scripts/shBrushSass.js",
"scala                  js/syntaxhighlighter/scripts/shBrushScala.js",
"sql                    js/syntaxhighlighter/scripts/shBrushSql.js",
"vb vbnet               js/syntaxhighlighter/scripts/shBrushVb.js",
"xml xhtml xslt html    js/syntaxhighlighter/scripts/shBrushXml.js"
);
	SyntaxHighlighter.defaults['auto-links'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all();
</script>




</body>
</html>