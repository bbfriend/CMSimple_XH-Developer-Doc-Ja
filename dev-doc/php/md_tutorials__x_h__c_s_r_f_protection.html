<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=9">
<meta name="generator" content="Doxygen 1.8.13">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CMSimple_XH: CSRF Protection</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />


<script type="text/javascript" src="js/syntaxhighlighter/scripts/XRegExp.js"></script>
<script type="text/javascript" src="js/syntaxhighlighter/scripts/shCore.js"></script>
<script type="text/javascript" src="js/syntaxhighlighter/scripts/shAutoloader.js"></script>
<link href="js/syntaxhighlighter/styles/shCoreDefault.css"" type="text/css" rel="stylesheet" />

</head>
<body cz-shortcut-listen="true">
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.jpg"></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CMSimple_XH
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>



<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<div class="header">
  <div class="headertitle">
<div class="title">CSRF 攻撃からの保護 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
<li class="level1"><a href="#usage">使い方 </a></li>
<li class="level1"><a href="#stronger-protection">強力な保護 </a></li>
<li class="level1"><a href="#external-scripts">外部スクリプト </a></li>
</ul>
</div>
<div class="textblock">
  <p><a href="https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%82%B9%E3%82%B5%E3%82%A4%E3%83%88%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%95%E3%82%A9%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%AA" target="_blank">Wikipedia</a> によると</p><blockquote class="doxtable">
<p>CSRF (Cross-site request forgery：クロスサイトリクエストフォージェリ)は、Webサイトに、信頼するユーザーから不正なコマンド（悪意のある攻撃を行う形式）が送信される攻撃方法です</p>
</blockquote>
<p>CMSimple_XHに関しては、狙われるユーザーは管理者であり、管理者がウェブサイトにログインしている間に偽造されたHTMLリクエストをトリックすることができます。 このようにして、攻撃者は、管理者が許可していることをすべて行うことができます。例えば、設定の変更やテンプレートの変更などが可能です。 CSRF攻撃のリスクはCMSimple_XHのWebサイトでは低いかもしれませんが、その重大度は非常に高いので、予防措置を講じることは妥当です。<br />
</p>
<p>CMSimple_XHのCSRF保護は、それぞれのフォームに配置され、ユーザーのセッションデータに格納されているランダムに作成された128ビット値（別名トークン）に基づいています。 フォーム提出時に、トークンが比較され、等しくない場合、フォーム提出は拒否されます。 トークンはセッションごとに更新されるため、フォームを偽造したい攻撃者は、現在予想されているトークンを&lt;emphasis&gt;推測&lt;/ emphasis&gt;しなければなりません。<br />
</p>
<p>今のところ、CSRF保護機能はグローバルオブジェクト<a href="cms_8php.html#a022468ab9e95e63bbd1570bb56616e8e">$ _XH_csrfProtection</a>　として利用可能になります。 これは将来のバージョンではかなり変更される可能性があります。<br />
</p>
<h1><a class="anchor" id="usage"></a>
使い方 </h1>
<p>CSRF攻撃から保護されなければならないすべてのフォームは、隠された入力要素によって拡張されなければなりません。<br />
  隠された入力要素は、 <a href="class_x_h_1_1_c_s_r_f_protection.html#a03cc85dba14fb59b3e816388b871087a">XH::CSRFProtection::tokenInput()</a>　を呼び出すことによって挿入できます。<br />
  例）送信側</p>
<p>
<pre class="brush:php;">&lt;form action=&quot;...&quot; method=&quot;post&quot;&gt;
....
&lt;?php echo $_XH_csrfProtection-&gt;tokenInput();?&gt;
&lt;/form&gt;</pre>
</p><p>フォームの受け側には、 XH::CSRFProtection::check()　呼び出すことによってトークンをチェックする必要があります。 <br />
  トークンが一致しない場合、スクリプトの実行はすぐに適切なメッセージで終了します。 この場合、メッセージは攻撃者には見えないが、誰かが自分のWebサイトに対してCSRF攻撃を試みたと簡単に結論づけることができる管理者が、このエラーを明確に示すことは合理的です。 <br />
  受け側の例：</p>
<p>
<pre class="brush:php;">
if (isset($_POST['my_form'])) {
    $_XH_csrfProtection->check();
    // processing form submission
}
</pre>
</p><p>基本的には全てに必要です。 新しいCSRFトークンの作成や、セッションに最新のトークンを格納する作業は、CMSimple_XHによって処理されます。<br />
単一のドキュメント（別名CMSimple_XHページ）に対してCSRF保護の複数のフォームが発行されたとしても、すべてが正常に動作するはずです。<br />
</p>
<p>管理フォームには、CMSimple_XHのコアと <a href="adminfuncs_8php.html#a7532bf327df77f5a630d73d32e851ea4">plugin_admin_common()</a> によってすでに用意されています。 <br />
  他の形態では、上記の方法でCSRF保護を追加する必要があります。<br />
</p>
<h1><a class="anchor" id="stronger-protection"></a>
  強力な保護 </h1>
<p>CSRF攻撃を受けても各セッションの共通のトークンが合理的な保護を提供しますが、上記は、各要求の新しいトークンなので更に安全です。 <br />
  しかし、後者には、Ajax、別のウィンドウ、複数のブラウザタブに関するいくつかの制限があります。これは、送信可能なフォームに古いトークンがまだ存在しているにもかかわらずトークンが更新される可能性があるからです。 したがって、トークンをセッションごとに1回更新するためのより簡単で柔軟なアプローチを採用することに決めました<br />
  While a common token for each session gives reasonable protection 
againgst CSRF attacks, a new token for each request is even more secure.
 However, the latter has several limitations regarding Ajax, separate 
windows and multiple browser tabs, as these might renew the token 
despite the old token still being present on forms which should be 
submittable. Therefore we have decided to stick with the more foolproof 
and flexible approach to renew the token once per session.</p>
<p>　 <a href="class_x_h_1_1_c_s_r_f_protection.html">XH::CSRFProtection クラス</a>では、独自のCSRFトークンを処理し、リクエストごとにセッションごとに1回更新するかどうかを選択できます。 これを行うには、クラスの独自のインスタンスを作成し、独自のキー名と、各要求に対して新しいトークンをを渡します。 <br />
  上記で説明した処理に加えて、要求終了時にセッション変数にCSRFトークンを格納する <a href="class_x_h_1_1_c_s_r_f_protection.html#a8826337c781700ed44d6a84e1b1cd730">XH::CSRFProtection::store()</a> を呼び出す必要 があります。 <br />
  概要：</p>
<p>
<pre class="brush:php;">
require_once $pth['folder']['classes'] . 'CSRFProtection.php';
$myCsrfProtection = new XH_CSRFProtection('my_csrf_key', true);
if (!isset($_POST[...])) {
    echo '<form ...>';
    // emit form input elements
    echo $myCsrfProtection->tokenInput();
    echo '</form>';
    $myCsrfProtection->store();
} else {
    $myCsrfProtection->check();
    // processing of form submission
}
</pre>
</p>
<h1><a class="anchor" id="external-scripts"></a>
外部スクリプト </h1>
<p>プラグインが「外部」スクリプトを要求することがあります。つまり、CMSimple_XHインストールのindex.phpを要求しません。 <br />
  この場合、 <a href="class_x_h_1_1_c_s_r_f_protection.html">XH::CSRFProtection クラス</a>はまったく使用できません。このクラスは、CMSimple_XHによって設定される変数、定数などに依存するためです。 クラスが正しく動作するようになるかもしれませんが、クラスの定義は次のバージョンで変更される可能性があります。 この場合、あなた自身のCSRF保護を実装する方がよいでしょう。 <br />
</p>
</div></div><!-- contents -->
<!-- start footer part -->

<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">構築:
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>





<script>
SyntaxHighlighter.autoloader
(
"applescript            js/syntaxhighlighter/scripts/shBrushAppleScript.js",
"actionscript3 as3      js/syntaxhighlighter/scripts/shBrushAS3.js",
"bash shell             js/syntaxhighlighter/scripts/shBrushBash.js",
"coldfusion cf          js/syntaxhighlighter/scripts/shBrushColdFusion.js",
"cpp c                  js/syntaxhighlighter/scripts/shBrushCpp.js",
"c# c-sharp csharp      js/syntaxhighlighter/scripts/shBrushCSharp.js",
"css                    js/syntaxhighlighter/scripts/shBrushCss.js",
"delphi pascal          js/syntaxhighlighter/scripts/shBrushDelphi.js",
"diff patch pas         js/syntaxhighlighter/scripts/shBrushDiff.js",
"erl erlang             js/syntaxhighlighter/scripts/shBrushErlang.js",
"groovy                 js/syntaxhighlighter/scripts/shBrushGroovy.js",
"java                   js/syntaxhighlighter/scripts/shBrushJava.js",
"jfx javafx             js/syntaxhighlighter/scripts/shBrushJavaFX.js",
"js jscript javascript  js/syntaxhighlighter/scripts/shBrushJScript.js",
"perl pl                js/syntaxhighlighter/scripts/shBrushPerl.js",
"php                    js/syntaxhighlighter/scripts/shBrushPhp.js",
"text plain             js/syntaxhighlighter/scripts/shBrushPlain.js",
"py python              js/syntaxhighlighter/scripts/shBrushPython.js",
"ruby rails ror rb      js/syntaxhighlighter/scripts/shBrushRuby.js",
"sass scss              js/syntaxhighlighter/scripts/shBrushSass.js",
"scala                  js/syntaxhighlighter/scripts/shBrushScala.js",
"sql                    js/syntaxhighlighter/scripts/shBrushSql.js",
"vb vbnet               js/syntaxhighlighter/scripts/shBrushVb.js",
"xml xhtml xslt html    js/syntaxhighlighter/scripts/shBrushXml.js"
);
	SyntaxHighlighter.defaults['auto-links'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
SyntaxHighlighter.all();
</script>




</body>
</html>